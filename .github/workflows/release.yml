# This workflow packages and uploads to CurseForge/Wago for alpha/beta,
# and uploads to GitHub Releases only for release tags.

name: Release

# Controls when the action will run.
on:
  # Alpha: run on every commit pushed to master
  push:
    branches: [ master ]
    tags:
      - "*" # Only release tags are expected to be pushed; beta tags are local-only.

  # Beta: run on a schedule (date-based version)
  schedule:
    - cron: "0 6 * * *"   # 06:00 UTC every day
    - cron: "0 16 * * 0"  # 16:00 UTC every Sunday

  # Manual trigger: allowed only on non-master branches
  workflow_dispatch:

jobs:
  check-context:
    # Manual trigger should be valid only on non-master branches
    if: >
      github.event_name != 'workflow_dispatch' ||
      github.ref != 'refs/heads/master'
    runs-on: ubuntu-latest
    outputs:
      mode: ${{ steps.mode.outputs.mode }}
      proceed: ${{ steps.guard.outputs.proceed }}
      beta_local_tag: ${{ steps.guard.outputs.beta_local_tag }}
    steps:
      - name: Determine mode
        id: mode
        shell: bash
        run: |
          MODE="alpha"

          if [ "${GITHUB_REF_TYPE}" = "tag" ]; then
            MODE="release"
          elif [ "${GITHUB_EVENT_NAME}" = "schedule" ]; then
            MODE="beta"
          fi

          echo "mode=$MODE" >> "$GITHUB_OUTPUT"
          echo "Selected mode: $MODE"

      - name: Checkout code
        uses: actions/checkout@v6
        if: steps.mode.outputs.mode == 'beta'
        with:
          fetch-depth: 300
          fetch-tags: true
          ref: ${{ github.sha }}


      - name: Check for changes since last tag
        id: check_changes
        if: steps.mode.outputs.mode == 'beta'
        shell: bash
        run: |
          MODE="${{ steps.mode.outputs.mode }}"
          PROCEED="true"
          BETA_TAG=""

          # Find the latest *release* tag only (X.Y.Z). Beta/rc/alpha tags are excluded.
          LAST_RELEASE_TAG=$(
            git tag --list "*" \
            | grep -E '^[0-9]+\.[0-9]+\.[0-9]+$' \
            | sort -V \
            | tail -n 1
          )

          HEAD_SHA="$(git rev-parse HEAD)"

          if [ -n "$LAST_RELEASE_TAG" ]; then
            RELEASE_SHA="$(git rev-list -n 1 "$LAST_RELEASE_TAG")"
          else
            RELEASE_SHA=""
          fi

          if [ "$MODE" = "beta" ] && [ -n "$RELEASE_SHA" ] && [ "$HEAD_SHA" = "$RELEASE_SHA" ]; then
            echo "Beta skipped: HEAD equals last release tag ($LAST_RELEASE_TAG)."
            PROCEED="false"
          fi

          # Create a date-based beta tag (local only) so packager treats the build as beta.
          if [ "$MODE" = "beta" ] && [ "$PROCEED" = "true" ]; then
            DATE=$(date -u +"%Y%m%d")
            BETA_TAG="v${DATE}-beta"

            # Avoid collisions if the workflow runs more than once per day.
            if git rev-parse "$BETA_TAG" >/dev/null 2>&1; then
              N=2
              while git rev-parse "${BETA_TAG}.${N}" >/dev/null 2>&1; do
                N=$((N+1))
              done
              BETA_TAG="${BETA_TAG}.${N}"
            fi
          fi

          echo "proceed=$PROCEED" >> "$GITHUB_OUTPUT"
          echo "beta_local_tag=$BETA_TAG" >> "$GITHUB_OUTPUT"

  build-windows:
    runs-on: windows-latest
    needs: check-context
    if: needs.check-context.outputs.mode != 'beta' || needs.check-context.outputs.proceed == 'true'
    steps:
      - uses: actions/checkout@v6
        with:
          ref: ${{ github.sha }}

      - name: Database Parser for Retail
        timeout-minutes: 5
        run: |
          cd .contrib/Parser
          "Parser.exe" auto baseconfig=.config/retail/retail.config
        shell: cmd

      - name: Database Parser for Classic Era
        timeout-minutes: 5
        run: |
          cd .contrib/Parser
          "Parser.exe" auto config=".config/classic/01 - Classic Era.config"
        shell: cmd

      - name: Database Parser for Season of Discovery
        timeout-minutes: 5
        run: |
          cd .contrib/Parser
          "Parser.exe" auto config=".config/classic/01 - Classic SOD.config"
        shell: cmd

      - name: Database Parser for The Burning Crusade
        timeout-minutes: 5
        run: |
          cd .contrib/Parser
          "Parser.exe" auto config=".config/classic/02 - TBC.config"
        shell: cmd

      - name: Database Parser for Wrath of the Lich King
        timeout-minutes: 5
        run: |
          cd .contrib/Parser
          "Parser.exe" auto config=".config/classic/03 - Wrath.config"
        shell: cmd

      - name: Database Parser for Cataclysm
        timeout-minutes: 5
        run: |
          cd .contrib/Parser
          "Parser.exe" auto config=".config/classic/04 - Cataclysm.config"
        shell: cmd

      - name: Database Parser for Mists of Pandaria
        timeout-minutes: 5
        run: |
          cd .contrib/Parser
          "Parser.exe" auto config=".config/classic/05 - Mists of Pandaria.config"
        shell: cmd

      - uses: actions/upload-artifact@v6
        with:
          name: db-output  # Artifact name
          path: db/  # File path to upload
          retention-days: 7

  release-linux:
    runs-on: ubuntu-latest
    needs: [check-context, build-windows]
    steps:
      - uses: actions/checkout@v6
        with:
          ref: ${{ github.sha }}

      - name: Debug git state
        shell: bash
        run: |
          echo "HEAD SHA: $(git rev-parse HEAD)"
          echo "Detached? $(git symbolic-ref -q HEAD || echo detached)"
          echo "Some tags:"
          git tag -l | head -n 20
          echo "Describe:"
          git describe --tags --abbrev=0 --match '[0-9]*.[0-9]*.[0-9]*' 2>/dev/null || true
          if git rev-parse --is-shallow-repository | grep -q true; then
            DEPTH=$(git rev-list --count HEAD)
            echo "shallow repo, current depth ~= $DEPTH"
          else
            echo "full clone"
          fi

      - name: Fetch tags with deeper history
        shell: bash
        run: |
          git config remote.origin.tagOpt --tags
          git fetch --deepen=300

      - name: Debug git state 2
        shell: bash
        run: |
          echo "HEAD SHA: $(git rev-parse HEAD)"
          echo "Detached? $(git symbolic-ref -q HEAD || echo detached)"
          echo "Some tags:"
          git tag -l | head -n 20
          echo "Describe:"
          git describe --tags --abbrev=0 --match '[0-9]*.[0-9]*.[0-9]*' 2>/dev/null || true
          if git rev-parse --is-shallow-repository | grep -q true; then
            DEPTH=$(git rev-list --count HEAD)
            echo "shallow repo, current depth ~= $DEPTH"
          else
            echo "full clone"
          fi

      - name: Download artifacts
        uses: actions/download-artifact@v7
        with:
          name: db-output  # Name of the artifact to download
          path: db

      - name: Create local beta tag (local only)
        if: needs.check-context.outputs.mode == 'beta'
        shell: bash
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          TAG="${{ needs.check-context.outputs.beta_local_tag }}"
          git tag -a "${TAG}" -m "Scheduled beta ${TAG}"
          echo "Local beta tag created: ${TAG}"

      # Alpha/Beta: upload to CF/Wago only (no GitHub Releases)
      - name: Package and upload (alpha/beta)
        if: needs.check-context.outputs.mode != 'release'
        uses: BigWigsMods/packager@v2
        env:
          CF_API_KEY: ${{ secrets.CF_API_KEY }}
          WAGO_API_TOKEN: ${{ secrets.WAGO_API_KEY }}
          #WOWI_API_TOKEN: ${{ secrets.WOWI_API_TOKEN }}

      # Release: upload to CF/Wago + GitHub Releases
      - name: Package and upload (release)
        if: needs.check-context.outputs.mode == 'release'
        uses: BigWigsMods/packager@v2
        env:
          CF_API_KEY: ${{ secrets.CF_API_KEY }}
          WAGO_API_TOKEN: ${{ secrets.WAGO_API_KEY }}
          #WOWI_API_TOKEN: ${{ secrets.WOWI_API_TOKEN }}
          GITHUB_OAUTH: ${{ secrets.GITHUB_OAUTH }}